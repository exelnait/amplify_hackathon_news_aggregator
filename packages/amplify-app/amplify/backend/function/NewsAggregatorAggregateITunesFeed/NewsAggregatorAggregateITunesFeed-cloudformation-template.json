{"AWSTemplateFormatVersion":"2010-09-09","Description":"{\"createdOn\":\"Mac\",\"createdBy\":\"Amplify\",\"createdWith\":\"12.1.1\",\"stackType\":\"function-Lambda\",\"metadata\":{}}","Parameters":{"CloudWatchRule":{"Type":"String","Default":"NONE","Description":" Schedule Expression"},"deploymentBucketName":{"Type":"String"},"env":{"Type":"String"},"s3Key":{"Type":"String"},"storageNewsAggregatorStorageBucketName":{"Type":"String","Default":"storageNewsAggregatorStorageBucketName"},"apinewsaggregatorGraphQLAPIIdOutput":{"Type":"String","Default":"apinewsaggregatorGraphQLAPIIdOutput"}},"Conditions":{"ShouldNotCreateEnvResources":{"Fn::Equals":[{"Ref":"env"},"NONE"]}},"Resources":{"LambdaFunction":{"Type":"AWS::Lambda::Function","Metadata":{"aws:asset:path":"./src","aws:asset:property":"Code"},"Properties":{"Code":{"S3Bucket":{"Ref":"deploymentBucketName"},"S3Key":{"Ref":"s3Key"}},"Handler":"index.handler","FunctionName":{"Fn::If":["ShouldNotCreateEnvResources","NewsAggregatorAggregateITunesFeed",{"Fn::Join":["",["NewsAggregatorAggregateITunesFeed","-",{"Ref":"env"}]]}]},"Environment":{"Variables":{"ENV":{"Ref":"env"},"REGION":{"Ref":"AWS::Region"},"STORAGE_NEWSAGGREGATORSTORAGE_BUCKETNAME":{"Ref":"storageNewsAggregatorStorageBucketName"},"API_NEWSAGGREGATOR_PICTURETABLE_NAME":{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PictureTable:Name"}},"API_NEWSAGGREGATOR_PICTURETABLE_ARN":{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PictureTable:Name"}}]]},"API_NEWSAGGREGATOR_GRAPHQLAPIIDOUTPUT":{"Ref":"apinewsaggregatorGraphQLAPIIdOutput"},"API_NEWSAGGREGATOR_NEWSITEMTABLE_NAME":{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:NewsItemTable:Name"}},"API_NEWSAGGREGATOR_NEWSITEMTABLE_ARN":{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:NewsItemTable:Name"}}]]},"API_NEWSAGGREGATOR_PUBLISHERSOURCETABLE_NAME":{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PublisherSourceTable:Name"}},"API_NEWSAGGREGATOR_PUBLISHERSOURCETABLE_ARN":{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PublisherSourceTable:Name"}}]]}}},"Role":{"Fn::GetAtt":["LambdaExecutionRole","Arn"]},"Runtime":"nodejs18.x","Layers":[],"Timeout":25}},"LambdaExecutionRole":{"Type":"AWS::IAM::Role","Properties":{"RoleName":{"Fn::If":["ShouldNotCreateEnvResources","newsaggregatorLambdaRolee89b0f24",{"Fn::Join":["",["newsaggregatorLambdaRolee89b0f24","-",{"Ref":"env"}]]}]},"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]},"Action":["sts:AssumeRole"]}]}}},"lambdaexecutionpolicy":{"DependsOn":["LambdaExecutionRole"],"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"lambda-execution-policy","Roles":[{"Ref":"LambdaExecutionRole"}],"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":{"Fn::Sub":["arn:aws:logs:${region}:${account}:log-group:/aws/lambda/${lambda}:log-stream:*",{"region":{"Ref":"AWS::Region"},"account":{"Ref":"AWS::AccountId"},"lambda":{"Ref":"LambdaFunction"}}]}}]}}},"AmplifyResourcesPolicy":{"DependsOn":["LambdaExecutionRole"],"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"amplify-lambda-execution-policy","Roles":[{"Ref":"LambdaExecutionRole"}],"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:PutObject"],"Resource":[{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"storageNewsAggregatorStorageBucketName"},"/*"]]}]},{"Effect":"Allow","Action":["dynamodb:Put*","dynamodb:Create*","dynamodb:BatchWriteItem","dynamodb:Update*","dynamodb:RestoreTable*"],"Resource":[{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PictureTable:Name"}}]]},{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PictureTable:Name"}},"/index/*"]]}]},{"Effect":"Allow","Action":["dynamodb:Put*","dynamodb:Create*","dynamodb:BatchWriteItem","dynamodb:Update*","dynamodb:RestoreTable*"],"Resource":[{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:NewsItemTable:Name"}}]]},{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:NewsItemTable:Name"}},"/index/*"]]}]},{"Effect":"Allow","Action":["dynamodb:Get*","dynamodb:BatchGetItem","dynamodb:List*","dynamodb:Describe*","dynamodb:Scan","dynamodb:Query"],"Resource":[{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PublisherSourceTable:Name"}}]]},{"Fn::Join":["",["arn:aws:dynamodb:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":table/",{"Fn::ImportValue":{"Fn::Sub":"${apinewsaggregatorGraphQLAPIIdOutput}:GetAtt:PublisherSourceTable:Name"}},"/index/*"]]}]}]}}},"CloudWatchEvent":{"Type":"AWS::Events::Rule","Properties":{"Description":"Schedule rule for Lambda","ScheduleExpression":{"Ref":"CloudWatchRule"},"State":"ENABLED","Targets":[{"Arn":{"Fn::GetAtt":["LambdaFunction","Arn"]},"Id":{"Ref":"LambdaFunction"}}]}},"PermissionForEventsToInvokeLambda":{"Type":"AWS::Lambda::Permission","Properties":{"FunctionName":{"Ref":"LambdaFunction"},"Action":"lambda:InvokeFunction","Principal":"events.amazonaws.com","SourceArn":{"Fn::GetAtt":["CloudWatchEvent","Arn"]}}}},"Outputs":{"Name":{"Value":{"Ref":"LambdaFunction"}},"Arn":{"Value":{"Fn::GetAtt":["LambdaFunction","Arn"]}},"Region":{"Value":{"Ref":"AWS::Region"}},"LambdaExecutionRole":{"Value":{"Ref":"LambdaExecutionRole"}},"LambdaExecutionRoleArn":{"Value":{"Fn::GetAtt":["LambdaExecutionRole","Arn"]}},"CloudWatchEventRule":{"Value":{"Ref":"CloudWatchEvent"}}}}